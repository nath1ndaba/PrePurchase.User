@page "/change-password"
@using PrePurchase.Mobile.Shared.Services.User
@using PrePurchase.Mobile.Shared.Services.Authentication
@inject IUserService UserService
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Change Password - PrePurchase</PageTitle>

<style>
    .change-password-page {
        background: var(--gray-100);
        min-height: 100vh;
    }

    .page-header {
        background: linear-gradient(135deg, var(--deep-blue) 0%, var(--primary-blue) 100%);
        padding: 20px;
        color: white;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .back-button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        backdrop-filter: blur(10px);
    }

    .page-title {
        font-size: 20px;
        font-weight: 700;
        flex: 1;
    }

    .form-container {
        background: white;
        margin: 20px;
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
    }

    .password-group {
        margin-bottom: 20px;
    }

    .password-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 8px;
        display: block;
    }

    .password-input-wrapper {
        position: relative;
    }

    .password-input {
        width: 100%;
        padding: 12px 50px 12px 16px;
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        font-size: 15px;
        transition: border-color 0.3s;
    }

        .password-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

    .toggle-password-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
    }

    .password-requirements {
        margin-top: 8px;
        font-size: 12px;
        color: var(--gray-600);
    }

    .submit-button {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, var(--primary-blue), var(--deep-blue));
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 8px;
    }

        .submit-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
</style>

<div class="change-password-page">
    <div class="page-header">
        <button class="back-button" @onclick="GoBack">←</button>
        <div class="page-title">Change Password</div>
    </div>

    <div class="form-container">
        <div class="password-group">
            <label class="password-label">Current Password</label>
            <div class="password-input-wrapper">
                <input type="@(_showCurrentPassword ? "text" : "password")"
                       @bind="_currentPassword"
                       class="password-input"
                       placeholder="Enter current password" />
                <button class="toggle-password-btn"
                        @onclick="() => _showCurrentPassword = !_showCurrentPassword">
                    @(_showCurrentPassword ? "🙈" : "👁️")
                </button>
            </div>
        </div>

        <div class="password-group">
            <label class="password-label">New Password</label>
            <div class="password-input-wrapper">
                <input type="@(_showNewPassword ? "text" : "password")"
                       @bind="_newPassword"
                       class="password-input"
                       placeholder="Enter new password" />
                <button class="toggle-password-btn"
                        @onclick="() => _showNewPassword = !_showNewPassword">
                    @(_showNewPassword ? "🙈" : "👁️")
                </button>
            </div>
            <div class="password-requirements">
                Minimum 6 characters required
            </div>
        </div>

        <div class="password-group">
            <label class="password-label">Confirm New Password</label>
            <div class="password-input-wrapper">
                <input type="@(_showConfirmPassword ? "text" : "password")"
                       @bind="_confirmPassword"
                       class="password-input"
                       placeholder="Confirm new password" />
                <button class="toggle-password-btn"
                        @onclick="() => _showConfirmPassword = !_showConfirmPassword">
                    @(_showConfirmPassword ? "🙈" : "👁️")
                </button>
            </div>
        </div>

        <button class="submit-button" @onclick="PasswordChanger" disabled="@_isChanging">
            @if (_isChanging)
            {
                <span>⏳ Changing Password...</span>
            }
            else
            {
                <span>🔒 Change Password</span>
            }
        </button>
    </div>
</div>

@code {
    private string _currentPassword = string.Empty;
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private bool _showCurrentPassword = false;
    private bool _showNewPassword = false;
    private bool _showConfirmPassword = false;
    private bool _isChanging = false;

    private async Task PasswordChanger()
    {
        // Validation
        if (string.IsNullOrWhiteSpace(_currentPassword))
        {
            Snackbar.Add("Please enter your current password", Severity.Warning);
            return;
        }

        if (string.IsNullOrWhiteSpace(_newPassword))
        {
            Snackbar.Add("Please enter a new password", Severity.Warning);
            return;
        }

        if (_newPassword.Length < 6)
        {
            Snackbar.Add("New password must be at least 6 characters long", Severity.Warning);
            return;
        }

        if (_newPassword != _confirmPassword)
        {
            Snackbar.Add("Passwords do not match", Severity.Error);
            return;
        }

        if (_currentPassword == _newPassword)
        {
            Snackbar.Add("New password must be different from current password", Severity.Warning);
            return;
        }

        _isChanging = true;
        StateHasChanged();

        try
        {
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser == null)
            {
                Snackbar.Add("User not found. Please login again.", Severity.Error);
                return;
            }

            var result = await UserService.ChangePasswordAsync(
                currentUser.Id,
                _currentPassword,
                _newPassword
            );

            if (result.IsSuccess)
            {
                Snackbar.Add("Password changed successfully! 🎉", Severity.Success);
                await Task.Delay(1500);
                Navigation.NavigateTo("/profile");
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to change password", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isChanging = false;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/profile");
    }
}